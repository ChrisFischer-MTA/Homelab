# Homelab

## What is this?
Every year or so, I do a tech refresh of my homelab. For this year, I wanted to build everything from scratch and document it well enough that others can deploy my setup, change it, modify it, or what have you. This is the mono-repo dedicated to my homelab.

## Design Considerations
My homelab stack is designed to be a series of web-based applications. Each web-based application is intended to have some degree of isolation. As a result, web applications are classified into `groups`. All the web applications which need to talk to each other can do so via a shared network. Most web applications do not have access to the internet. All web applications are accessed after requests pass through a ModSec Web Application Firewall and then a dedicated reverse proxy. Watchtower sits on top of all docker containers and automatically updates everything.

## What does it run?
This repo currently has support for the following services:
- Keycloak (Single Sign On/Forcing MFA across all applications)
- Open Web UI (AI/Local LLM generation)
- Journal Application (ChrisFischer-MTA/Journaling-Application)

### What I am planning on adding:
- Gitlab (I code things and want a local CI/CI pipeline)
- Nextcloud (File retention)
- RSync (File backup)
- Jellyfin (Family video playing/retention)
- Asciinema (Terminal Recording utility for when I do CTFs/HackTheBox)

## What is the hardware behind your homelab?
My homelab runs on a custom built PC using consumer hardware. I am currently evaluating buying 4x 20TB Spinners. If I do buy them, I will likely not buy a new case. If you are, for whatever reason, thinking about replicating my setup - I suggest a slightly larger case. I live in a very space constrained enviroment, so, I chose the smallest possible case.
- `CPU` : `Intel i9-14900KS 3.2 GHz 24 Core`
- `Cooler` : `ARTIC Liquid Freezer III 240mm CFM Liquid CPU Cooler`
- `Motherboard` : `MSI MPG B760I EDGE WIFI Mini ITX LGA 1700 Motherboard`
- `Memory` : `G.Skill Ripjaws S5 64 GB (2x32GB) DDR5 6000`
- `GPU` : `Acer Nitro OC Arc B580 12GB Video Card`
- `Case` : `Cooler Master MasterBox NR200P V2 Mini`
- `Power Supply` : `Asus ROG LOKI 1000W 80+ Platinum`

## Can I replicate your stuff?

### ENV File
The ENV file requires you define the following variables:
```
# Variables for the postgres bootstrap user
POSTGRES_DB
POSTGRES_USER
POSTGRES_PASSWORD

# Keycloak Bootstrap Variables
KEYCLOAK_ADMIN
KEYCLOAK_ADMIN_PASSWORD
KC_BOOT_USER
KC_BOOT_PASS
KC_DB_USERNAME
KC_DB_PASSWORD
KC_JDBC_CON_STRING

# Journal App Variables
JOURNAL_SECRET_KEY
JOURNAL_SIGNAL_NUMBER
JOURNAL_WEBAPP_USERNAME
JOURNAL_DJANGO_DEBUG
JOURNAL_APP_DB_NAME
JOURNAL_APP_DB_USER_NAME
JOURNAL_APP_DB_PASSWORD
JOURNAL_APP_DB_HOST
JOURNAL_APP_DB_PORT

NEXTCLOUD_POSTGRES_DB
NEXTCLOUD_POSTGRES_DB_USER
NEXTCLOUD_POSTGRES_DB_PASSWORD
NEXTCLOUD_POSTGRES_DB_HOST
```

### Setup Guide

#### First run: Setting up database users

First, create the keycloak database and the database user. Replace with your own password
```postgresql
create database journalingapp;
create user journaldbuser with encrypted password 'journaldbpass';
grant all privileges on database journalingapp to journaldbuser;
\c journalingapp postgres
GRANT ALL ON SCHEMA public TO journaldbuser;
create database keycloak;
create user keycloakdbuser with encrypted password 'keycloakdbpass';
grant all privileges on database keycloak to keycloakdbuser;
\c keycloak postgres
GRANT ALL ON SCHEMA public TO keycloakdbuser;
create database nextclouddb;
create user nextclouddbuser with encrypted password 'nextclouddbpass';
grant all privileges on database nextclouddb to nextclouddbuser;
\c nextclouddb postgres
GRANT ALL ON SCHEMA public TO nextclouddbuser;
```

#### Setting up Keycloak
Log in with the user you created, scope to the master realm. Add a DNS record for the INTERNAL name of Keycloak.

##### Journal App
Create a new user client, call it `journaling-app-client`. Give it a root URL of `http://<external journal DNS>:8080/` and a home URL of `http://<external journal DNS>:8080/admin`. Tick `Client Authentication` and `Authorization`. Ensure client authenticator is set to `Client Id and Secret`. Set the vhost to have the ClientID and ClientName.

##### Setting up Elastic for Nextcloud
Elastic will spit a ton of errors on first start. Drop into the container using `docker exec -it homelab-elastic-1 bash` and then run the following command to generate the credentials: `/usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic`. You should get output roughly matching the following:

```
[elasticsearch@3e57d89774f6 ~]$ /usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic
WARNING: Owner of file [/usr/share/elasticsearch/config/users] used to be [root], but now is [elasticsearch]
WARNING: Owner of file [/usr/share/elasticsearch/config/users_roles] used to be [root], but now is [elasticsearch]
This tool will reset the password of the [elastic] user to an autogenerated value.
The password will be printed in the console.
Please confirm that you would like to continue [y/N]y


Password for the [elastic] user successfully reset.
New value: V1uyyr==qs1xN-y*hRPu
```



You can test it using the following example:
```
curl --cacert /usr/share/elasticsearch/config/certs/http_ca.crt -u 'elastic:V1uyyr==qs1xN-y*hRPu' https://127.1:9200/ -vvv -k
```

Now, go into nextcloud and download the full text search app and the full text search files app. From there, enter in the connection string (our example would be: `https://elastic:V1uyyr==qs1xN-y*hRPu@homelab-elastic-1:9200`). Scroll through the rest of the options and configure as needed.

Then, drop into postgres container:
`docker exec -it homelab-postgres-1 bash`
`psql -U postgres`
`\c nextclouddb`
`INSERT INTO oc_appconfig (appid, configkey, configvalue) VALUES ('fulltextsearch_elasticsearch', 'allow_self_signed_cert', 'true');`
exit out of it

Drop into nextcloud bash
`docker exec -it homelab-nextcloud-1 bash`
`php occ fulltextsearch:index`

Exit out
Now, remove the internet connection from docker compose


-- Legacy Readme below. Going to work thse things into the above readme at some point.

Note:
Gateway is technically a reverse proxy itself. I could include a apache.conf file that has all the options specific to modsec. However, I don't do this here because modsec changes often enough in my experience I'd rather have the container autogenerate the configuration and have a secondary container that contains my proxy hosts.

Proxy:
- Using an Entrypoint here to install the `/usr/lib/apache2/modules/mod_auth_openidc.so` which provides openidc auth for frontdooring my applications. This is very hacky and not ideal, plus requires our frontdoor to have internet which seems like a huge vulnerability.
- Added to httpd `LoadModule auth_openidc_module /usr/lib/apache2/modules/mod_auth_openidc.so`; note that you have to specify the full path here because apt for some reason puts it in /lib/ and not /local/ where everything else is.

Notes:
 - The internal and external DNS resolution must work due to the way IDC is configured.
 
Known cron needs:
`http://nextcloud-test:8080/cron.php`

backup-service: cron commands

Nextcloud requires a special configuration for the gateway to allow bigger requests such that things work
recognize and maps
todo: add gpu acceleration for jellyfin
